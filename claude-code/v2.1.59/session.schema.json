{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/moru-ai/agent-schemas/claude-code/v2.1.59/session.schema.json",
  "title": "Claude Code Session Schema (v2.1.59)",
  "description": "Schema for Claude Code CLI session JSONL format. Each line in a .jsonl file should validate against this schema. Covers CLI versions 2.1.2 through 2.1.59.",
  "x-cli-version": "2.1.59",
  "x-generated-date": "2026-02-27",
  "x-data-source": "Mined from 248 JSONL files across 2 days of real CLI 2.1.59 usage (DES-5006/DES-5062).",

  "oneOf": [
    { "$ref": "#/$defs/UserMessage" },
    { "$ref": "#/$defs/AssistantMessage" },
    { "$ref": "#/$defs/SystemMessage" },
    { "$ref": "#/$defs/SummaryMessage" },
    { "$ref": "#/$defs/FileHistorySnapshot" },
    { "$ref": "#/$defs/QueueOperation" },
    { "$ref": "#/$defs/ProgressMessage" },
    { "$ref": "#/$defs/PRLinkMessage" }
  ],

  "$defs": {
    "UUID": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "UUID v4 format"
    },

    "ISO8601Timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp"
    },

    "CLIVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "CLI version string (semver)",
      "examples": ["2.0.62", "2.0.76", "2.1.1", "2.1.59"]
    },

    "ModelId": {
      "type": "string",
      "description": "Claude model identifier",
      "examples": [
        "claude-opus-4-5-20251101",
        "claude-opus-4-6",
        "claude-sonnet-4-5-20250929",
        "claude-sonnet-4-6",
        "claude-haiku-4-5-20251001",
        "<synthetic>"
      ]
    },

    "BuiltInToolName": {
      "type": "string",
      "enum": [
        "Bash",
        "Read",
        "Write",
        "Edit",
        "Glob",
        "Grep",
        "WebSearch",
        "WebFetch",
        "Task",
        "TaskOutput",
        "TaskStop",
        "TaskCreate",
        "TaskUpdate",
        "TaskList",
        "TaskGet",
        "TodoWrite",
        "AskUserQuestion",
        "NotebookEdit",
        "EnterPlanMode",
        "ExitPlanMode",
        "EnterWorktree",
        "Skill",
        "KillShell",
        "ToolSearch",
        "SendMessage",
        "TeamCreate",
        "TeamDelete",
        "ListMcpResourcesTool",
        "ReadMcpResourceTool"
      ],
      "description": "Built-in tool name. New in v2.1.x: ToolSearch, SendMessage, TaskCreate/Update/List/Get, TeamCreate/Delete, TaskStop, EnterWorktree, ListMcpResourcesTool, ReadMcpResourceTool."
    },

    "MCPToolName": {
      "type": "string",
      "pattern": "^mcp__[a-zA-Z0-9_:-]+__[a-zA-Z0-9_-]+$",
      "description": "MCP tool name pattern: mcp__<server>__<tool>. Server names may contain colons (e.g., plugin:sentry:sentry)."
    },

    "ToolName": {
      "oneOf": [
        { "$ref": "#/$defs/BuiltInToolName" },
        { "$ref": "#/$defs/MCPToolName" }
      ],
      "description": "Tool name (built-in or MCP)"
    },


    "BashInput": {
      "type": "object",
      "properties": {
        "command": { "type": "string", "description": "The bash command to execute" },
        "description": { "type": "string", "description": "Short description of command purpose" },
        "timeout": { "type": "integer", "minimum": 0, "maximum": 600000, "description": "Timeout in milliseconds" },
        "run_in_background": { "type": "boolean", "description": "Run command in background" },
        "dangerouslyDisableSandbox": { "type": "boolean", "description": "Disable sandbox mode" }
      },
      "required": ["command"],
      "additionalProperties": false
    },

    "ReadInput": {
      "type": "object",
      "properties": {
        "file_path": { "type": "string", "description": "Absolute path to file" },
        "offset": { "type": "integer", "minimum": 0, "description": "Line number to start reading from" },
        "limit": { "type": "integer", "minimum": 1, "description": "Number of lines to read" },
        "pages": { "type": "string", "description": "Page range for PDF files (e.g., '1-5')" }
      },
      "required": ["file_path"],
      "additionalProperties": false
    },

    "WriteInput": {
      "type": "object",
      "properties": {
        "file_path": { "type": "string", "description": "Absolute path to file" },
        "content": { "type": "string", "description": "Content to write" }
      },
      "required": ["file_path", "content"],
      "additionalProperties": false
    },

    "EditInput": {
      "type": "object",
      "properties": {
        "file_path": { "type": "string", "description": "Absolute path to file" },
        "old_string": { "type": "string", "description": "Text to replace" },
        "new_string": { "type": "string", "description": "Replacement text" },
        "replace_all": { "type": "boolean", "default": false, "description": "Replace all occurrences" }
      },
      "required": ["file_path", "old_string", "new_string"],
      "additionalProperties": false
    },

    "GlobInput": {
      "type": "object",
      "properties": {
        "pattern": { "type": "string", "description": "Glob pattern to match" },
        "path": { "type": "string", "description": "Directory to search in" }
      },
      "required": ["pattern"],
      "additionalProperties": false
    },

    "GrepInput": {
      "type": "object",
      "properties": {
        "pattern": { "type": "string", "description": "Regex pattern to search" },
        "path": { "type": "string", "description": "File or directory to search" },
        "output_mode": { "type": "string", "enum": ["content", "files_with_matches", "count"] },
        "glob": { "type": "string", "description": "Glob pattern to filter files" },
        "type": { "type": "string", "description": "File type to search (e.g., js, py)" },
        "head_limit": { "type": "integer", "minimum": 0, "description": "Limit output lines" },
        "offset": { "type": "integer", "minimum": 0, "description": "Skip first N lines" },
        "multiline": { "type": "boolean", "description": "Enable multiline mode" },
        "context": { "type": "integer", "minimum": 0, "description": "Lines of context (alias for -C)" },
        "-A": { "type": "integer", "minimum": 0, "description": "Lines after match" },
        "-B": { "type": "integer", "minimum": 0, "description": "Lines before match" },
        "-C": { "type": "integer", "minimum": 0, "description": "Lines of context" },
        "-i": { "type": "boolean", "description": "Case insensitive" },
        "-n": { "type": "boolean", "description": "Show line numbers" }
      },
      "required": ["pattern"],
      "additionalProperties": false
    },

    "WebSearchInput": {
      "type": "object",
      "properties": {
        "query": { "type": "string", "minLength": 2, "description": "Search query" },
        "allowed_domains": { "type": "array", "items": { "type": "string" }, "description": "Domains to include" },
        "blocked_domains": { "type": "array", "items": { "type": "string" }, "description": "Domains to exclude" }
      },
      "required": ["query"],
      "additionalProperties": false
    },

    "WebFetchInput": {
      "type": "object",
      "properties": {
        "url": { "type": "string", "format": "uri", "description": "URL to fetch" },
        "prompt": { "type": "string", "description": "Prompt for processing content" }
      },
      "required": ["url", "prompt"],
      "additionalProperties": false
    },

    "TaskInput": {
      "type": "object",
      "description": "Spawn a subagent or team member. New fields in v2.1.x: model, name, team_name, mode, max_turns, isolation.",
      "properties": {
        "description": { "type": "string", "description": "Short task description (3-5 words)" },
        "prompt": { "type": "string", "description": "Task prompt for agent" },
        "subagent_type": { "type": "string", "description": "Type of agent to use (e.g., general-purpose, Explore, Plan)" },
        "run_in_background": { "type": "boolean", "description": "Run agent in background" },
        "model": { "type": "string", "enum": ["sonnet", "opus", "haiku"], "description": "Model override for subagent" },
        "resume": { "type": "string", "description": "Agent ID to resume" },
        "name": { "type": "string", "description": "Named agent identifier (used with team_name for team members)" },
        "team_name": { "type": "string", "description": "Team to join (links to TeamCreate)" },
        "mode": {
          "type": "string",
          "enum": ["acceptEdits", "bypassPermissions", "default", "dontAsk", "plan"],
          "description": "Permission mode for spawned agent"
        },
        "max_turns": { "type": "integer", "exclusiveMinimum": 0, "description": "Max agentic turns before stopping" },
        "isolation": { "type": "string", "enum": ["worktree"], "description": "Isolation mode — worktree creates a temporary git worktree" }
      },
      "required": ["description", "prompt", "subagent_type"],
      "additionalProperties": false
    },

    "TodoItem": {
      "type": "object",
      "properties": {
        "content": { "type": "string", "minLength": 1, "description": "Task description (imperative form)" },
        "status": { "type": "string", "enum": ["pending", "in_progress", "completed"] },
        "activeForm": { "type": "string", "minLength": 1, "description": "Present continuous form" }
      },
      "required": ["content", "status", "activeForm"],
      "additionalProperties": false
    },

    "TodoWriteInput": {
      "type": "object",
      "properties": {
        "todos": {
          "type": "array",
          "items": { "$ref": "#/$defs/TodoItem" },
          "description": "Updated todo list"
        }
      },
      "required": ["todos"],
      "additionalProperties": false
    },

    "QuestionOption": {
      "type": "object",
      "properties": {
        "label": { "type": "string", "description": "Display text for option" },
        "description": { "type": "string", "description": "Explanation of option" },
        "markdown": { "type": "string", "description": "Preview content shown when option is focused" }
      },
      "required": ["label", "description"],
      "additionalProperties": false
    },

    "Question": {
      "type": "object",
      "properties": {
        "question": { "type": "string", "description": "The question to ask" },
        "header": { "type": "string", "maxLength": 12, "description": "Short label (max 12 chars)" },
        "options": {
          "type": "array",
          "items": { "$ref": "#/$defs/QuestionOption" },
          "minItems": 2,
          "maxItems": 4
        },
        "multiSelect": { "type": "boolean", "default": false }
      },
      "required": ["question", "header", "options", "multiSelect"],
      "additionalProperties": false
    },

    "AskUserQuestionInput": {
      "type": "object",
      "properties": {
        "questions": {
          "type": "array",
          "items": { "$ref": "#/$defs/Question" },
          "minItems": 1,
          "maxItems": 4
        },
        "answers": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "User answers"
        },
        "annotations": {
          "type": "object",
          "additionalProperties": { "type": "object" },
          "description": "Per-question annotations (notes, markdown preview selections)"
        },
        "metadata": {
          "type": "object",
          "properties": {
            "source": { "type": "string", "description": "Source identifier (e.g., 'remember')" }
          },
          "additionalProperties": false,
          "description": "Tracking/analytics metadata"
        }
      },
      "required": ["questions"],
      "additionalProperties": false
    },

    "NotebookEditInput": {
      "type": "object",
      "properties": {
        "notebook_path": { "type": "string", "description": "Absolute path to notebook" },
        "new_source": { "type": "string", "description": "New cell source" },
        "cell_id": { "type": "string", "description": "Cell ID to edit" },
        "cell_type": { "type": "string", "enum": ["code", "markdown"] },
        "edit_mode": { "type": "string", "enum": ["replace", "insert", "delete"] }
      },
      "required": ["notebook_path", "new_source"],
      "additionalProperties": false
    },

    "EnterPlanModeInput": {
      "type": "object",
      "properties": {},
      "additionalProperties": false
    },

    "AllowedPrompt": {
      "type": "object",
      "properties": {
        "tool": { "type": "string", "enum": ["Bash"], "description": "Tool this prompt applies to" },
        "prompt": { "type": "string", "description": "Semantic description of the allowed action" }
      },
      "required": ["tool", "prompt"],
      "additionalProperties": false
    },

    "ExitPlanModeInput": {
      "type": "object",
      "properties": {
        "plan": { "type": "string", "description": "Plan content" },
        "allowedPrompts": {
          "type": "array",
          "items": { "$ref": "#/$defs/AllowedPrompt" },
          "description": "Prompt-based permissions needed to implement the plan"
        }
      },
      "additionalProperties": true
    },

    "SkillInput": {
      "type": "object",
      "properties": {
        "skill": { "type": "string", "description": "Skill name to invoke" },
        "args": { "type": "string", "description": "Optional arguments" }
      },
      "required": ["skill"],
      "additionalProperties": false
    },

    "KillShellInput": {
      "type": "object",
      "properties": {
        "shell_id": { "type": "string", "description": "ID of shell to kill" }
      },
      "required": ["shell_id"],
      "additionalProperties": false
    },

    "TaskOutputInput": {
      "type": "object",
      "properties": {
        "task_id": { "type": "string", "description": "Task ID to get output from" },
        "block": { "type": "boolean", "default": true, "description": "Wait for completion" },
        "timeout": { "type": "integer", "minimum": 0, "maximum": 600000, "description": "Max wait time in ms" }
      },
      "required": ["task_id", "block", "timeout"],
      "additionalProperties": false
    },

    "TaskStopInput": {
      "type": "object",
      "properties": {
        "task_id": { "type": "string", "description": "Background task ID to stop" },
        "shell_id": { "type": "string", "description": "Deprecated: use task_id instead" }
      },
      "additionalProperties": false
    },

    "ToolSearchInput": {
      "type": "object",
      "description": "Search for or select deferred tools to make them available. Use 'select:<tool_name>' for exact lookup or keywords for search.",
      "properties": {
        "query": { "type": "string", "description": "Keyword search or 'select:<tool_name>' for direct selection" },
        "max_results": { "type": "integer", "default": 5, "minimum": 1, "description": "Maximum results to return" }
      },
      "required": ["query", "max_results"],
      "additionalProperties": false
    },

    "SendMessageInput": {
      "type": "object",
      "description": "Inter-agent messaging in a team context. Supports 5 message types: message, broadcast, shutdown_request, shutdown_response, plan_approval_response.",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["message", "broadcast", "shutdown_request", "shutdown_response", "plan_approval_response"],
          "description": "Message type"
        },
        "recipient": { "type": "string", "description": "Agent name of recipient (for message, shutdown_request, plan_approval_response)" },
        "content": { "type": "string", "description": "Message text, reason, or feedback" },
        "summary": { "type": "string", "description": "5-10 word summary shown as UI preview (for message, broadcast)" },
        "request_id": { "type": "string", "description": "Request ID to respond to (for shutdown_response, plan_approval_response)" },
        "approve": { "type": "boolean", "description": "Whether to approve (for shutdown_response, plan_approval_response)" }
      },
      "required": ["type"],
      "additionalProperties": false
    },

    "TaskCreateInput": {
      "type": "object",
      "description": "Create a task in the team's shared task list.",
      "properties": {
        "subject": { "type": "string", "description": "Brief task title (imperative form)" },
        "description": { "type": "string", "description": "Detailed description with context and acceptance criteria" },
        "activeForm": { "type": "string", "description": "Present continuous form shown in spinner" },
        "metadata": { "type": "object", "additionalProperties": true, "description": "Arbitrary metadata" }
      },
      "required": ["subject", "description"],
      "additionalProperties": false
    },

    "TaskUpdateInput": {
      "type": "object",
      "description": "Update an existing task's status, description, or dependencies.",
      "properties": {
        "taskId": { "type": "string", "description": "Task ID to update" },
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "deleted"],
          "description": "New task status"
        },
        "subject": { "type": "string", "description": "New task title" },
        "description": { "type": "string", "description": "New task description" },
        "activeForm": { "type": "string", "description": "Present continuous form" },
        "owner": { "type": "string", "description": "Agent name to assign" },
        "metadata": { "type": "object", "additionalProperties": true, "description": "Metadata to merge" },
        "addBlocks": { "type": "array", "items": { "type": "string" }, "description": "Task IDs this task blocks" },
        "addBlockedBy": { "type": "array", "items": { "type": "string" }, "description": "Task IDs that block this task" }
      },
      "required": ["taskId"],
      "additionalProperties": false
    },

    "TaskListInput": {
      "type": "object",
      "description": "List all tasks in the team's task list.",
      "properties": {},
      "additionalProperties": false
    },

    "TaskGetInput": {
      "type": "object",
      "description": "Retrieve a task by ID.",
      "properties": {
        "taskId": { "type": "string", "description": "Task ID to retrieve" }
      },
      "required": ["taskId"],
      "additionalProperties": false
    },

    "TeamCreateInput": {
      "type": "object",
      "description": "Create a new team for multi-agent coordination.",
      "properties": {
        "team_name": { "type": "string", "description": "Slug/identifier for the team" },
        "description": { "type": "string", "description": "Team purpose" },
        "agent_type": { "type": "string", "description": "Role of the calling agent in the team" }
      },
      "required": ["team_name"],
      "additionalProperties": false
    },

    "TeamDeleteInput": {
      "type": "object",
      "description": "Delete the current team and clean up resources.",
      "properties": {},
      "additionalProperties": false
    },

    "EnterWorktreeInput": {
      "type": "object",
      "description": "Create an isolated git worktree for the session.",
      "properties": {
        "name": { "type": "string", "description": "Optional name for the worktree" }
      },
      "additionalProperties": false
    },

    "ListMcpResourcesInput": {
      "type": "object",
      "description": "List available resources from configured MCP servers.",
      "properties": {
        "server": { "type": "string", "description": "Optional server name to filter by" }
      },
      "additionalProperties": false
    },

    "ReadMcpResourceInput": {
      "type": "object",
      "description": "Read a specific resource from an MCP server.",
      "properties": {
        "server": { "type": "string", "description": "MCP server name" },
        "uri": { "type": "string", "description": "Resource URI to read" }
      },
      "required": ["server", "uri"],
      "additionalProperties": false
    },

    "MCPToolInput": {
      "type": "object",
      "description": "Generic MCP tool input",
      "additionalProperties": true
    },

    "ToolInput": {
      "description": "Tool-specific input parameters",
      "oneOf": [
        { "$ref": "#/$defs/BashInput" },
        { "$ref": "#/$defs/ReadInput" },
        { "$ref": "#/$defs/WriteInput" },
        { "$ref": "#/$defs/EditInput" },
        { "$ref": "#/$defs/GlobInput" },
        { "$ref": "#/$defs/GrepInput" },
        { "$ref": "#/$defs/WebSearchInput" },
        { "$ref": "#/$defs/WebFetchInput" },
        { "$ref": "#/$defs/TaskInput" },
        { "$ref": "#/$defs/TaskOutputInput" },
        { "$ref": "#/$defs/TaskStopInput" },
        { "$ref": "#/$defs/ToolSearchInput" },
        { "$ref": "#/$defs/SendMessageInput" },
        { "$ref": "#/$defs/TaskCreateInput" },
        { "$ref": "#/$defs/TaskUpdateInput" },
        { "$ref": "#/$defs/TaskListInput" },
        { "$ref": "#/$defs/TaskGetInput" },
        { "$ref": "#/$defs/TeamCreateInput" },
        { "$ref": "#/$defs/TeamDeleteInput" },
        { "$ref": "#/$defs/EnterWorktreeInput" },
        { "$ref": "#/$defs/ListMcpResourcesInput" },
        { "$ref": "#/$defs/ReadMcpResourceInput" },
        { "$ref": "#/$defs/TodoWriteInput" },
        { "$ref": "#/$defs/AskUserQuestionInput" },
        { "$ref": "#/$defs/NotebookEditInput" },
        { "$ref": "#/$defs/EnterPlanModeInput" },
        { "$ref": "#/$defs/ExitPlanModeInput" },
        { "$ref": "#/$defs/SkillInput" },
        { "$ref": "#/$defs/KillShellInput" },
        { "$ref": "#/$defs/MCPToolInput" }
      ]
    },


    "TextBlock": {
      "type": "object",
      "properties": {
        "type": { "const": "text" },
        "text": { "type": "string" }
      },
      "required": ["type", "text"],
      "additionalProperties": false
    },

    "ThinkingBlock": {
      "type": "object",
      "properties": {
        "type": { "const": "thinking" },
        "thinking": { "type": "string", "description": "Claude's reasoning" },
        "signature": { "type": "string", "description": "Cryptographic signature (base64)" }
      },
      "required": ["type", "thinking", "signature"],
      "additionalProperties": false
    },

    "ToolUseCaller": {
      "type": "object",
      "description": "Identifies how the tool was invoked. Currently always {\"type\": \"direct\"}.",
      "properties": {
        "type": { "type": "string", "description": "Caller type (e.g., 'direct')" }
      },
      "required": ["type"],
      "additionalProperties": true
    },

    "ToolUseBlock": {
      "type": "object",
      "description": "Tool invocation block. New in v2.1.x: 'caller' field on every tool_use block.",
      "properties": {
        "type": { "const": "tool_use" },
        "id": {
          "type": "string",
          "pattern": "^toolu_[a-zA-Z0-9]+$",
          "description": "Tool use ID"
        },
        "name": { "$ref": "#/$defs/ToolName" },
        "input": { "type": "object", "description": "Tool-specific input" },
        "caller": { "$ref": "#/$defs/ToolUseCaller" }
      },
      "required": ["type", "id", "name", "input"],
      "additionalProperties": false
    },

    "ToolReferenceBlock": {
      "type": "object",
      "description": "Compact reference to a tool (returned by ToolSearch). New in v2.1.x.",
      "properties": {
        "type": { "const": "tool_reference" },
        "tool_name": { "type": "string", "description": "Name of the referenced tool" }
      },
      "required": ["type", "tool_name"],
      "additionalProperties": false
    },

    "ToolResultContentItem": {
      "oneOf": [
        { "type": "string" },
        {
          "type": "object",
          "properties": {
            "type": { "const": "text" },
            "text": { "type": "string" }
          },
          "required": ["type", "text"]
        },
        {
          "type": "object",
          "properties": {
            "type": { "const": "image" },
            "source": {
              "type": "object",
              "properties": {
                "type": { "const": "base64" },
                "media_type": { "type": "string", "enum": ["image/png", "image/jpeg", "image/gif", "image/webp"] },
                "data": { "type": "string" }
              },
              "required": ["type", "media_type", "data"]
            }
          },
          "required": ["type", "source"]
        },
        { "$ref": "#/$defs/ToolReferenceBlock" }
      ]
    },

    "ToolResultBlock": {
      "type": "object",
      "properties": {
        "type": { "const": "tool_result" },
        "tool_use_id": {
          "type": "string",
          "pattern": "^toolu_[a-zA-Z0-9]+$"
        },
        "content": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "array",
              "items": { "$ref": "#/$defs/ToolResultContentItem" }
            }
          ]
        },
        "is_error": { "type": "boolean" }
      },
      "required": ["type", "tool_use_id", "content"],
      "additionalProperties": false
    },

    "ImageBlock": {
      "type": "object",
      "properties": {
        "type": { "const": "image" },
        "source": {
          "type": "object",
          "properties": {
            "type": { "const": "base64" },
            "media_type": { "type": "string", "enum": ["image/png", "image/jpeg", "image/gif", "image/webp"] },
            "data": { "type": "string", "contentEncoding": "base64" }
          },
          "required": ["type", "media_type", "data"]
        }
      },
      "required": ["type", "source"],
      "additionalProperties": false
    },

    "ContentBlock": {
      "oneOf": [
        { "$ref": "#/$defs/TextBlock" },
        { "$ref": "#/$defs/ThinkingBlock" },
        { "$ref": "#/$defs/ToolUseBlock" },
        { "$ref": "#/$defs/ToolResultBlock" },
        { "$ref": "#/$defs/ImageBlock" },
        { "$ref": "#/$defs/ToolReferenceBlock" }
      ]
    },

    "ThinkingMetadata": {
      "type": "object",
      "properties": {
        "level": { "type": "string", "enum": ["high", "medium", "low"] },
        "disabled": { "type": "boolean" },
        "triggers": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": true
    },

    "UsageInfo": {
      "type": "object",
      "description": "Token usage and inference metadata. New in v2.1.x: inference_geo, iterations, speed.",
      "properties": {
        "input_tokens": { "type": "integer", "minimum": 0 },
        "output_tokens": { "type": "integer", "minimum": 0 },
        "cache_creation_input_tokens": { "type": "integer", "minimum": 0 },
        "cache_read_input_tokens": { "type": "integer", "minimum": 0 },
        "cache_creation": {
          "type": "object",
          "properties": {
            "ephemeral_5m_input_tokens": { "type": "integer" },
            "ephemeral_1h_input_tokens": { "type": "integer" }
          },
          "additionalProperties": true
        },
        "service_tier": { "oneOf": [{ "type": "string" }, { "type": "null" }] },
        "server_tool_use": {
          "type": "object",
          "properties": {
            "web_search_requests": { "type": "integer" },
            "web_fetch_requests": { "type": "integer" }
          },
          "additionalProperties": true
        },
        "inference_geo": {
          "oneOf": [{ "type": "string" }, { "type": "null" }],
          "description": "Inference geographic region (e.g., 'not_available', empty string, or null)"
        },
        "iterations": {
          "oneOf": [
            { "type": "array", "items": { "type": "object" } },
            { "type": "null" }
          ],
          "description": "Iteration details (observed as empty array or null)"
        },
        "speed": {
          "oneOf": [{ "type": "string" }, { "type": "null" }],
          "description": "Inference speed tier (e.g., 'standard', or null)"
        }
      },
      "required": ["input_tokens", "output_tokens"],
      "additionalProperties": true
    },

    "UserMessageContent": {
      "oneOf": [
        { "type": "string" },
        {
          "type": "array",
          "items": { "$ref": "#/$defs/ContentBlock" }
        }
      ],
      "description": "User message content - string when isCompactSummary, array otherwise"
    },

    "UserMessage": {
      "type": "object",
      "description": "User input message. New in v2.1.x: permissionMode, teamName, imagePasteIds.",
      "properties": {
        "type": { "const": "user" },
        "uuid": { "$ref": "#/$defs/UUID" },
        "parentUuid": {
          "oneOf": [
            { "$ref": "#/$defs/UUID" },
            { "type": "null" }
          ]
        },
        "sessionId": { "$ref": "#/$defs/UUID" },
        "timestamp": { "$ref": "#/$defs/ISO8601Timestamp" },
        "version": { "$ref": "#/$defs/CLIVersion" },
        "cwd": { "type": "string", "description": "Current working directory" },
        "gitBranch": { "type": "string", "description": "Git branch name" },
        "isSidechain": { "type": "boolean" },
        "userType": { "type": "string", "const": "external" },
        "message": {
          "type": "object",
          "properties": {
            "role": { "const": "user" },
            "content": { "$ref": "#/$defs/UserMessageContent" }
          },
          "required": ["role", "content"],
          "additionalProperties": true
        },
        "thinkingMetadata": { "$ref": "#/$defs/ThinkingMetadata" },
        "todos": {
          "type": "array",
          "items": { "$ref": "#/$defs/TodoItem" }
        },
        "isMeta": { "type": "boolean" },
        "isCompactSummary": { "type": "boolean", "description": "When true, content is summary string" },
        "agentId": { "type": "string", "description": "Agent ID (in agent session files)" },
        "slug": { "type": "string", "description": "Human-readable session name" },
        "toolUseResult": {
          "oneOf": [
            { "type": "object" },
            { "type": "string" },
            {
              "type": "array",
              "items": { "$ref": "#/$defs/ToolResultContentItem" },
              "description": "Tool result content items"
            }
          ],
          "description": "Tool result metadata (v2.1.1+) — can be object, string, or array of content items"
        },
        "sourceToolAssistantUUID": {
          "$ref": "#/$defs/UUID",
          "description": "UUID of assistant message that triggered tool (v2.1.1+)"
        },
        "permissionMode": {
          "type": "string",
          "enum": ["default", "acceptEdits", "bypassPermissions", "dontAsk", "plan"],
          "description": "Active permission mode for this turn (v2.1.x+)"
        },
        "teamName": {
          "type": "string",
          "description": "Team name when operating in a team context (v2.1.x+)"
        },
        "imagePasteIds": {
          "type": "array",
          "items": { "oneOf": [{ "type": "string" }, { "type": "integer" }] },
          "description": "IDs of pasted images (v2.1.x+)"
        }
      },
      "required": ["type", "uuid", "parentUuid", "sessionId", "timestamp", "version", "cwd", "isSidechain", "userType", "message"],
      "additionalProperties": true
    },

    "AssistantMessage": {
      "type": "object",
      "description": "Claude's response message. New in v2.1.x: teamName.",
      "properties": {
        "type": { "const": "assistant" },
        "uuid": { "$ref": "#/$defs/UUID" },
        "parentUuid": {
          "oneOf": [
            { "$ref": "#/$defs/UUID" },
            { "type": "null" }
          ]
        },
        "sessionId": { "$ref": "#/$defs/UUID" },
        "timestamp": { "$ref": "#/$defs/ISO8601Timestamp" },
        "version": { "$ref": "#/$defs/CLIVersion" },
        "cwd": { "type": "string" },
        "gitBranch": { "type": "string" },
        "isSidechain": { "type": "boolean" },
        "userType": { "type": "string", "const": "external" },
        "requestId": {
          "type": "string",
          "pattern": "^req_[a-zA-Z0-9]+$",
          "description": "API request ID"
        },
        "message": {
          "type": "object",
          "properties": {
            "model": { "$ref": "#/$defs/ModelId" },
            "id": {
              "type": "string",
              "description": "API message ID (msg_* pattern or UUID for synthetic)"
            },
            "type": { "const": "message" },
            "role": { "const": "assistant" },
            "content": {
              "type": "array",
              "items": { "$ref": "#/$defs/ContentBlock" }
            },
            "stop_reason": {
              "oneOf": [
                { "type": "string", "enum": ["end_turn", "tool_use", "max_tokens", "stop_sequence"] },
                { "type": "null" }
              ]
            },
            "stop_sequence": {
              "oneOf": [
                { "type": "string" },
                { "type": "null" }
              ]
            },
            "usage": { "$ref": "#/$defs/UsageInfo" }
          },
          "required": ["model", "id", "type", "role", "content", "stop_reason", "stop_sequence", "usage"],
          "additionalProperties": true
        },
        "agentId": { "type": "string" },
        "slug": { "type": "string" },
        "isApiErrorMessage": { "type": "boolean", "description": "Whether this is an API error message" },
        "error": { "type": "string", "description": "Error type (e.g., rate_limit)" },
        "teamName": { "type": "string", "description": "Team name when operating in a team context (v2.1.x+)" }
      },
      "required": ["type", "uuid", "parentUuid", "sessionId", "timestamp", "version", "cwd", "isSidechain", "userType", "message"],
      "additionalProperties": true
    },

    "SystemMessage": {
      "type": "object",
      "description": "System event message. New in v2.1.x: bridge_status subtype with url field, retry metadata fields.",
      "properties": {
        "type": { "const": "system" },
        "uuid": { "$ref": "#/$defs/UUID" },
        "parentUuid": {
          "oneOf": [
            { "$ref": "#/$defs/UUID" },
            { "type": "null" }
          ]
        },
        "sessionId": { "$ref": "#/$defs/UUID" },
        "timestamp": { "$ref": "#/$defs/ISO8601Timestamp" },
        "version": { "$ref": "#/$defs/CLIVersion" },
        "cwd": { "type": "string" },
        "gitBranch": { "type": "string" },
        "isSidechain": { "type": "boolean" },
        "userType": { "type": "string", "const": "external" },
        "subtype": {
          "type": "string",
          "enum": ["local_command", "turn_duration", "api_error", "stop_hook_summary", "compact_boundary", "bridge_status"],
          "description": "System message subtype. New in v2.1.x: bridge_status."
        },
        "content": { "type": "string", "description": "Message content" },
        "level": { "type": "string", "enum": ["info", "warn", "error", "suggestion"] },
        "durationMs": { "type": "integer", "minimum": 0, "description": "Duration in milliseconds" },
        "isMeta": { "type": "boolean" },
        "agentId": { "type": "string" },
        "slug": { "type": "string" },
        "hookCount": { "type": "integer", "description": "Number of hooks triggered (stop_hook_summary)" },
        "hookInfos": { "type": "array", "items": { "type": "object" }, "description": "Hook information (stop_hook_summary)" },
        "hookErrors": { "type": "array", "items": { "oneOf": [{ "type": "object" }, { "type": "string" }] }, "description": "Hook errors (stop_hook_summary)" },
        "preventedContinuation": { "type": "boolean", "description": "Whether hook prevented continuation" },
        "stopReason": { "type": "string", "description": "Reason for stop" },
        "hasOutput": { "type": "boolean", "description": "Whether there is output" },
        "toolUseID": { "type": "string", "description": "Tool use ID" },
        "logicalParentUuid": { "$ref": "#/$defs/UUID", "description": "Logical parent UUID (compact_boundary)" },
        "compactMetadata": {
          "type": "object",
          "properties": {
            "trigger": { "type": "string" },
            "preTokens": { "type": "integer" }
          },
          "description": "Compact metadata (compact_boundary)"
        },
        "url": {
          "type": "string",
          "format": "uri",
          "description": "URL for bridge_status subtype (remote control session link)"
        },
        "cause": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "object",
              "properties": {
                "code": { "type": "string", "description": "Error code (e.g., ConnectionRefused, FailedToOpenSocket)" },
                "path": { "type": "string", "description": "Request URL path" },
                "errno": { "type": "integer" }
              },
              "additionalProperties": true
            }
          ],
          "description": "Error cause — string or object with code/path/errno (api_error retry metadata)"
        },
        "retryInMs": { "type": "number", "minimum": 0, "description": "Retry delay in milliseconds (can be fractional)" },
        "retryAttempt": { "type": "integer", "minimum": 0, "description": "Current retry attempt number" },
        "maxRetries": { "type": "integer", "minimum": 0, "description": "Maximum retry attempts" }
      },
      "required": ["type", "uuid", "parentUuid", "sessionId", "timestamp", "version", "cwd", "isSidechain", "userType", "subtype"],
      "additionalProperties": true
    },

    "SummaryMessage": {
      "type": "object",
      "properties": {
        "type": { "const": "summary" },
        "summary": { "type": "string", "description": "Human-readable conversation summary" },
        "leafUuid": { "$ref": "#/$defs/UUID", "description": "UUID of last summarized message" }
      },
      "required": ["type", "summary", "leafUuid"],
      "additionalProperties": true
    },

    "FileBackupInfo": {
      "type": "object",
      "properties": {
        "originalContent": { "type": "string", "description": "Original file content (legacy)" },
        "path": { "type": "string", "description": "File path (legacy)" },
        "backupFileName": {
          "oneOf": [
            { "type": "string" },
            { "type": "null" }
          ],
          "description": "Backup file identifier"
        },
        "version": { "type": "integer", "minimum": 1, "description": "Backup version number" },
        "backupTime": { "$ref": "#/$defs/ISO8601Timestamp", "description": "Backup timestamp" }
      },
      "additionalProperties": true
    },

    "FileHistorySnapshot": {
      "type": "object",
      "properties": {
        "type": { "const": "file-history-snapshot" },
        "messageId": { "$ref": "#/$defs/UUID" },
        "snapshot": {
          "type": "object",
          "properties": {
            "messageId": { "$ref": "#/$defs/UUID" },
            "trackedFileBackups": {
              "type": "object",
              "additionalProperties": { "$ref": "#/$defs/FileBackupInfo" },
              "description": "Map of file path to backup info"
            },
            "timestamp": { "$ref": "#/$defs/ISO8601Timestamp" }
          },
          "required": ["messageId", "trackedFileBackups", "timestamp"],
          "additionalProperties": true
        },
        "isSnapshotUpdate": { "type": "boolean" }
      },
      "required": ["type", "messageId", "snapshot", "isSnapshotUpdate"],
      "additionalProperties": true
    },

    "QueueOperation": {
      "type": "object",
      "description": "Queue operation for message queuing",
      "properties": {
        "type": { "const": "queue-operation" },
        "operation": { "type": "string", "enum": ["enqueue", "remove", "dequeue", "popAll"] },
        "timestamp": { "$ref": "#/$defs/ISO8601Timestamp" },
        "sessionId": { "$ref": "#/$defs/UUID" },
        "content": { "type": "string", "description": "Message content (for enqueue)" }
      },
      "required": ["type", "operation", "timestamp", "sessionId"],
      "additionalProperties": true
    },


    "MCPProgressData": {
      "type": "object",
      "description": "MCP tool execution progress",
      "properties": {
        "type": { "const": "mcp_progress" },
        "status": { "type": "string", "enum": ["started", "completed", "failed"] },
        "serverName": { "type": "string", "description": "MCP server name (e.g., 'linear-server', 'plugin:sentry:sentry')" },
        "toolName": { "type": "string", "description": "MCP tool name" },
        "elapsedTimeMs": { "type": "integer", "minimum": 0, "description": "Elapsed time (present on completed/failed)" }
      },
      "required": ["type", "status", "serverName", "toolName"],
      "additionalProperties": true
    },

    "BashProgressData": {
      "type": "object",
      "description": "Bash command execution progress",
      "properties": {
        "type": { "const": "bash_progress" },
        "output": { "type": "string", "description": "Truncated stdout/stderr" },
        "fullOutput": { "type": "string", "description": "Full stdout/stderr" },
        "elapsedTimeSeconds": { "type": "integer", "minimum": 0 },
        "totalLines": { "type": "integer", "minimum": 0 },
        "totalBytes": { "type": "integer", "minimum": 0, "description": "Total bytes (background tasks)" },
        "taskId": { "type": "string", "description": "Background task ID" },
        "timeoutMs": { "type": "integer", "minimum": 0, "description": "Configured timeout" }
      },
      "required": ["type", "output", "fullOutput", "elapsedTimeSeconds", "totalLines"],
      "additionalProperties": true
    },

    "HookProgressData": {
      "type": "object",
      "description": "Hook execution progress",
      "properties": {
        "type": { "const": "hook_progress" },
        "hookEvent": {
          "type": "string",
          "enum": ["PreToolUse", "PostToolUse", "SessionStart", "SubagentStop", "Stop"],
          "description": "Hook event type"
        },
        "hookName": { "type": "string", "description": "Hook name (e.g., 'PostToolUse:Grep')" },
        "command": { "type": "string", "description": "Hook command" }
      },
      "required": ["type", "hookEvent", "hookName", "command"],
      "additionalProperties": true
    },

    "AgentProgressData": {
      "type": "object",
      "description": "Subagent execution progress",
      "properties": {
        "type": { "const": "agent_progress" },
        "agentId": { "type": "string", "description": "Subagent ID" },
        "prompt": { "type": "string", "description": "Task prompt (may be truncated)" },
        "normalizedMessages": { "type": "array", "description": "Accumulated subagent messages" },
        "message": { "type": "object", "description": "Full conversation message sent to subagent" }
      },
      "required": ["type", "agentId", "prompt"],
      "additionalProperties": true
    },

    "WaitingForTaskData": {
      "type": "object",
      "description": "Waiting for a background task to complete",
      "properties": {
        "type": { "const": "waiting_for_task" },
        "taskDescription": { "type": "string" },
        "taskType": { "type": "string", "enum": ["local_bash", "local_agent"], "description": "Background task type" }
      },
      "required": ["type", "taskDescription", "taskType"],
      "additionalProperties": true
    },

    "QueryUpdateData": {
      "type": "object",
      "description": "WebSearch query submission progress",
      "properties": {
        "type": { "const": "query_update" },
        "query": { "type": "string", "description": "Search query submitted" }
      },
      "required": ["type", "query"],
      "additionalProperties": true
    },

    "SearchResultsReceivedData": {
      "type": "object",
      "description": "WebSearch results received",
      "properties": {
        "type": { "const": "search_results_received" },
        "resultCount": { "type": "integer", "minimum": 0 },
        "query": { "type": "string" }
      },
      "required": ["type", "resultCount", "query"],
      "additionalProperties": true
    },

    "ProgressData": {
      "description": "Progress event data — discriminated by data.type",
      "oneOf": [
        { "$ref": "#/$defs/MCPProgressData" },
        { "$ref": "#/$defs/BashProgressData" },
        { "$ref": "#/$defs/HookProgressData" },
        { "$ref": "#/$defs/AgentProgressData" },
        { "$ref": "#/$defs/WaitingForTaskData" },
        { "$ref": "#/$defs/QueryUpdateData" },
        { "$ref": "#/$defs/SearchResultsReceivedData" }
      ]
    },

    "ProgressMessage": {
      "type": "object",
      "description": "Streaming progress event. New in v2.1.x. Accounts for ~44% of all JSONL lines. Subtypes: mcp_progress, bash_progress, hook_progress, agent_progress, waiting_for_task, query_update, search_results_received.",
      "properties": {
        "type": { "const": "progress" },
        "uuid": { "$ref": "#/$defs/UUID" },
        "sessionId": { "$ref": "#/$defs/UUID" },
        "parentUuid": {
          "oneOf": [
            { "$ref": "#/$defs/UUID" },
            { "type": "null" }
          ]
        },
        "timestamp": { "$ref": "#/$defs/ISO8601Timestamp" },
        "version": { "$ref": "#/$defs/CLIVersion" },
        "cwd": { "type": "string" },
        "gitBranch": { "type": "string" },
        "isSidechain": { "type": "boolean" },
        "userType": { "type": "string", "const": "external" },
        "slug": { "type": "string", "description": "Human-readable session name (may be absent)" },
        "toolUseID": { "type": "string", "description": "Associated tool use ID" },
        "parentToolUseID": { "type": "string", "description": "Parent tool use ID (for nested tool calls)" },
        "data": { "$ref": "#/$defs/ProgressData" }
      },
      "required": ["type", "uuid", "sessionId", "parentUuid", "timestamp", "version", "cwd", "isSidechain", "userType", "data"],
      "additionalProperties": true
    },

    "PRLinkMessage": {
      "type": "object",
      "description": "Lightweight PR link record. Emitted once when Claude creates or references a pull request. New in v2.1.x.",
      "properties": {
        "type": { "const": "pr-link" },
        "sessionId": { "$ref": "#/$defs/UUID" },
        "prNumber": { "type": "integer", "minimum": 1, "description": "Pull request number" },
        "prUrl": { "type": "string", "format": "uri", "description": "Full PR URL" },
        "prRepository": { "type": "string", "description": "Repository identifier (e.g., 'owner/repo')" },
        "timestamp": { "$ref": "#/$defs/ISO8601Timestamp" }
      },
      "required": ["type", "sessionId", "prNumber", "prUrl", "prRepository", "timestamp"],
      "additionalProperties": true
    }
  }
}
